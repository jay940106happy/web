<!DOCTYPE html>
<html lang="zh-Hant">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes"
  />

  <title>K ç·šåœ–</title>
  <link rel="stylesheet" href="{% static 'core/style.css' %}" />

  <!-- ä½¿ç”¨ ECharts ç•« K ç·šï¼‹è²¡å ±åœ– -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
  <h1>æ¸¬è©¦ K ç·šåœ–</h1>

  <form method="get" action="{% url 'k_chart' %}">
    <label>
      è‚¡ç¥¨ä»£è™Ÿï¼š
      <input
        type="text"
        name="code"
        value="{{ raw_code|default:'2330' }}"
        placeholder="2330"
      />
    </label>
    <button type="submit">æŸ¥è©¢</button>
  </form>

  {# ===== ä¸Šæ–¹å°ˆæ¥­é ­éƒ¨è³‡è¨Šï¼ˆåƒ Yahoo é‚£ä¸€å¡Šï¼‰ ===== #}
  {% if company_name and last_close %}
    <div class="quote-header">
      <div class="quote-top-row">
        <span class="symbol">{{ raw_code|upper }}</span>
        <span class="name">{{ company_name }}</span>
      </div>
      <div class="quote-price-row">
        <span class="price">{{ last_close|floatformat:2 }}</span>
        {% if last_change %}
          {% if last_change > 0 %}
            <span class="change up">
              â–² {{ last_change|floatformat:2 }}
              ({{ last_change_pct|floatformat:2 }}%)
            </span>
          {% elif last_change < 0 %}
            <span class="change down">
              â–¼ {{ last_change|floatformat:2 }}
              ({{ last_change_pct|floatformat:2 }}%)
            </span>
          {% else %}
            <span class="change flat">
              0.00 (0.00%)
            </span>
          {% endif %}
        {% endif %}
      </div>
      {% if last_date %}
        <div class="quote-date">
          æ”¶ç›¤åƒ¹ Â· {{ last_date }}
        </div>
      {% endif %}
    </div>
  {% endif %}

  {% if error %}
    <p style="color: red">{{ error }}</p>
  {% endif %}

  {% if not error %}
    <h2>{{ symbol }} æ—¥ K</h2>
    <div id="kchart" style="width: 100%; height: 600px;"></div>

    <!-- ===== ä¸‹æ–¹ï¼šè²¡å ±åˆ†æç¸½å€ ===== -->
    <section class="fund-section">
      <!-- Tab æŒ‰éˆ• -->
      <div class="fund-tabs">
        <button class="fund-tab active" data-tab="snapshot">ç¸½è¦½</button>
        <button class="fund-tab" data-tab="ratios">è²¡å‹™æ¯”ç‡</button>
        <button class="fund-tab" data-tab="trend">è²¡å ±è¶¨å‹¢åœ–</button>
      </div>

      <!-- Tab å…§å®¹ï¼šç¸½è¦½ -->
      <div id="tab-snapshot" class="fund-panel active">
        <div class="fund-grid">
          <div class="fund-card">
            <div class="fund-card-title">å…¬å¸è³‡è¨Š</div>
            <table>
              <tbody>
                <tr>
                  <td>ç”¢æ¥­</td>
                  <td>{{ fund_info.sector|default:"-" }}</td>
                </tr>
                <tr>
                  <td>å­ç”¢æ¥­</td>
                  <td>{{ fund_info.industry|default:"-" }}</td>
                </tr>
                <tr>
                  <td>åœ‹å®¶</td>
                  <td>{{ fund_info.country|default:"-" }}</td>
                </tr>
                <tr>
                  <td>å“¡å·¥æ•¸</td>
                  <td>
                    {% if fund_info.employees %}
                      {{ fund_info.employees|floatformat:"0" }} äºº
                    {% else %}
                      -
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <td>å¹£åˆ¥</td>
                  <td>{{ fund_info.currency|default:"-" }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="fund-card">
            <div class="fund-card-title">ä¼°å€¼æŒ‡æ¨™</div>
            <table>
              <tbody>
                <tr>
                  <td>å¸‚å€¼</td>
                  <td>
                    {% if fund_info.marketCap %}
                      {{ fund_info.marketCap|floatformat:"0" }}
                    {% else %}-{% endif %}
                  </td>
                </tr>
                <tr>
                  <td>æœ¬ç›Šæ¯” (TTM)</td>
                  <td>{{ fund_info.trailingPE|default:"-" }}</td>
                </tr>
                <tr>
                  <td>é ä¼°æœ¬ç›Šæ¯”</td>
                  <td>{{ fund_info.forwardPE|default:"-" }}</td>
                </tr>
                <tr>
                  <td>PEG</td>
                  <td>{{ fund_info.pegRatio|default:"-" }}</td>
                </tr>
                <tr>
                  <td>è‚¡åƒ¹æ·¨å€¼æ¯” P/B</td>
                  <td>{{ fund_info.priceToBook|default:"-" }}</td>
                </tr>
                <tr>
                  <td>Beta</td>
                  <td>{{ fund_info.beta|default:"-" }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="fund-card">
            <div class="fund-card-title">è‚¡åˆ©ï¼†ç²åˆ©èƒ½åŠ›</div>
            <table>
              <tbody>
                <tr>
                  <td>æ®–åˆ©ç‡</td>
                  <td>
                    {% if fund_info.dividendYieldPct %}
                      {{ fund_info.dividendYieldPct|floatformat:"2" }} %
                    {% else %}-{% endif %}
                  </td>
                </tr>
                <tr>
                  <td>ç›ˆé¤˜é…ç™¼ç‡</td>
                  <td>
                    {% if fund_info.payoutRatio %}
                      {{ fund_info.payoutRatio|floatformat:"2" }}
                    {% else %}-{% endif %}
                  </td>
                </tr>
                <tr>
                  <td>æ·¨åˆ©ç‡</td>
                  <td>
                    {% if fund_info.profitMarginsPct %}
                      {{ fund_info.profitMarginsPct|floatformat:"2" }} %
                    {% else %}-{% endif %}
                  </td>
                </tr>
                <tr>
                  <td>ç‡Ÿç›Šç‡</td>
                  <td>
                    {% if fund_info.operatingMarginsPct %}
                      {{ fund_info.operatingMarginsPct|floatformat:"2" }} %
                    {% else %}-{% endif %}
                  </td>
                </tr>
                <tr>
                  <td>ROE</td>
                  <td>
                    {% if fund_info.roe %}
                      {{ fund_info.roe|floatformat:"2" }}
                    {% else %}-{% endif %}
                  </td>
                </tr>
                <tr>
                  <td>ROA</td>
                  <td>
                    {% if fund_info.roa %}
                      {{ fund_info.roa|floatformat:"2" }}
                    {% else %}-{% endif %}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tab å…§å®¹ï¼šè²¡å‹™æ¯”ç‡ï¼ˆå†æ•´ç†ä¸€æ¬¡é‡è¦æ¯”ç‡ï¼‰ -->
      <div id="tab-ratios" class="fund-panel">
        <div class="fund-card wide">
          <div class="fund-card-title">è²¡å‹™é«”è³ª / é¢¨éšªæŒ‡æ¨™</div>
          <table>
            <tbody>
              <tr>
                <td style="width: 140px;">è² å‚µæ¬Šç›Šæ¯” (D/E)</td>
                <td>
                  {% if fund_info.debtToEquity %}
                    {{ fund_info.debtToEquity|floatformat:"2" }}
                  {% else %}-{% endif %}
                </td>
              </tr>
              <tr>
                <td>ç‡Ÿç›Šç‡ (TTM)</td>
                <td>
                  {% if fund_info.operatingMarginsPct %}
                    {{ fund_info.operatingMarginsPct|floatformat:"2" }} %
                  {% else %}-{% endif %}
                </td>
              </tr>
              <tr>
                <td>æ·¨åˆ©ç‡ (TTM)</td>
                <td>
                  {% if fund_info.profitMarginsPct %}
                    {{ fund_info.profitMarginsPct|floatformat:"2" }} %
                  {% else %}-{% endif %}
                </td>
              </tr>
              <tr>
                <td>ROE (TTM)</td>
                <td>
                  {% if fund_info.roe %}
                    {{ fund_info.roe|floatformat:"2" }}
                  {% else %}-{% endif %}
                </td>
              </tr>
              <tr>
                <td>ROA (TTM)</td>
                <td>
                  {% if fund_info.roa %}
                    {{ fund_info.roa|floatformat:"2" }}
                  {% else %}-{% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tab å…§å®¹ï¼šè²¡å ±è¶¨å‹¢åœ– -->
      <div id="tab-trend" class="fund-panel">
        <div class="metric-buttons">
          <span class="metric-label">æŒ‡æ¨™ï¼š</span>
          <button class="metric-btn active" data-metric="revenue">ç‡Ÿæ”¶</button>
          <button class="metric-btn" data-metric="operatingIncome">ç‡Ÿæ¥­åˆ©ç›Š</button>
          <button class="metric-btn" data-metric="netIncome">æ·¨åˆ©</button>
          <button class="metric-btn" data-metric="grossMargin">æ¯›åˆ©ç‡ %</button>
          <button class="metric-btn" data-metric="operatingMargin">ç‡Ÿç›Šç‡ %</button>
          <button class="metric-btn" data-metric="netMargin">æ·¨åˆ©ç‡ %</button>
          <button class="metric-btn" data-metric="operatingCashFlow">ç‡Ÿæ¥­ç¾é‡‘æµ</button>
        </div>
        <div id="fund-chart" style="width: 100%; height: 320px;"></div>
      </div>
    </section>

    <script>
      // ===== å¾Œç«¯è³‡æ–™ =====
      const ohlc = {{ ohlc_json|default:"[]"|safe }};
      const fundamentals = {{ fundamentals_json|default:"{}"|safe }};

      // ===== 1. K ç·šåœ– (ECharts) =====
      if (ohlc.length > 0) {
        const container = document.getElementById("kchart");
        const chart = echarts.init(container, null, { renderer: "canvas" });

        const dates = ohlc.map(r => r.date);
        const kData = ohlc.map(r => [r.open, r.close, r.low, r.high]);
        const volumeData = ohlc.map((r, idx) => {
          const up = r.close >= r.open;
          return { value: [idx, r.volume, up ? 1 : -1] };
        });

        const option = {
          backgroundColor: "#0f172a",
          animation: false,
          tooltip: {
            trigger: "axis",
            axisPointer: {
              type: "cross",
              label: { backgroundColor: "#374151" }
            }
          },
          axisPointer: {
            link: [{ xAxisIndex: [0, 1] }]
          },
          grid: [
            { left: 50, right: 20, top: 40, height: "58%" },
            { left: 50, right: 20, top: "70%", height: "18%" }
          ],
          xAxis: [
            {
              type: "category",
              data: dates,
              boundaryGap: false,
              axisLine: { lineStyle: { color: "#4b5563" } },
              axisLabel: { color: "#9ca3af" },
              min: "dataMin",
              max: "dataMax"
            },
            {
              type: "category",
              gridIndex: 1,
              data: dates,
              boundaryGap: false,
              axisLine: { lineStyle: { color: "#4b5563" } },
              axisLabel: { color: "#9ca3af" },
              min: "dataMin",
              max: "dataMax"
            }
          ],
          yAxis: [
            {
              scale: true,
              position: "right",
              axisLine: { lineStyle: { color: "#4b5563" } },
              axisLabel: { color: "#e5e7eb" },
              splitLine: { lineStyle: { color: "#1f2937" } }
            },
            {
              gridIndex: 1,
              position: "right",
              axisLine: { lineStyle: { color: "#4b5563" } },
              axisLabel: {
                color: "#9ca3af",
                formatter: value => {
                  if (value >= 1e8) return (value / 1e8).toFixed(1) + "å„„";
                  if (value >= 1e4) return (value / 1e4).toFixed(1) + "è¬";
                  return value;
                }
              },
              splitLine: { show: false }
            }
          ],
          dataZoom: [
            {
              type: "inside",
              xAxisIndex: [0, 1],
              minSpan: 5
            },
            {
              type: "slider",
              xAxisIndex: [0, 1],
              height: 16,
              bottom: 10
            }
          ],
          series: [
            {
              name: "K ç·š",
              type: "candlestick",
              data: kData,
              itemStyle: {
                color: "#ff5c5c",
                color0: "#26e27a",
                borderColor: "#ff5c5c",
                borderColor0: "#26e27a"
              }
            },
            {
              name: "æˆäº¤é‡",
              type: "bar",
              xAxisIndex: 1,
              yAxisIndex: 1,
              data: volumeData,
              itemStyle: {
                color: params =>
                  params.data.value[2] === 1 ? "#ff5c5c" : "#26e27a"
              }
            }
          ]
        };

        chart.setOption(option);
        window.addEventListener("resize", () => chart.resize());
      }

        // ===== 2. è²¡å ±è¶¨å‹¢åœ–ï¼šå»¶å¾Œåˆ°ç¬¬ä¸€æ¬¡é» tab å†åˆå§‹åŒ– =====
        let fundChart = null;          // å…¨åŸŸåƒè€ƒï¼Œä¹‹å¾Œ tab åˆ‡æ› / resize è¦ç”¨
        let fundChartInited = false;   // é¿å…é‡è¤‡åˆå§‹åŒ–

        function initFundChart() {
        if (fundChartInited) return;                     // å·²ç¶“ init éå°±ä¸ç”¨å†ä¾†ä¸€æ¬¡
        if (!fundamentals || !fundamentals.series) return;

        const fundChartEl = document.getElementById("fund-chart");
        if (!fundChartEl) return;

        // âš ï¸ é€™è£¡æ‰ initï¼Œç¢ºä¿ tab-trend æ˜¯é¡¯ç¤ºç‹€æ…‹
        fundChart = echarts.init(fundChartEl, null, { renderer: "canvas" });
        fundChartInited = true;

        const metricNameMap = {
            revenue: "ç‡Ÿæ”¶",
            operatingIncome: "ç‡Ÿæ¥­åˆ©ç›Š",
            netIncome: "æ·¨åˆ©",
            grossMargin: "æ¯›åˆ©ç‡ %",
            operatingMargin: "ç‡Ÿç›Šç‡ %",
            netMargin: "æ·¨åˆ©ç‡ %",
            operatingCashFlow: "ç‡Ÿæ¥­ç¾é‡‘æµ",
            totalAssets: "ç¸½è³‡ç”¢",
            totalLiabilities: "ç¸½è² å‚µ",
        };

        // æ•¸å­—ç¸®å¯«æˆ è¬ / å„„ / å…†
        function formatNumberAbbrev(value) {
            const v = Number(value);
            if (!isFinite(v)) return "-";
            const abs = Math.abs(v);
            if (abs >= 1e12) return (v / 1e12).toFixed(2) + "å…†";
            if (abs >= 1e8)  return (v / 1e8 ).toFixed(2) + "å„„";
            if (abs >= 1e4)  return (v / 1e4 ).toFixed(2) + "è¬";
            return v.toLocaleString();
        }

        function isPercentMetric(key) {
            return key.toLowerCase().includes("margin");
        }

        function renderMetric(key) {
            const series = fundamentals.series[key];
            if (!series || !series.length) {
            fundChart.clear();
            fundChart.setOption({
                title: {
                text: "æ­¤æŒ‡æ¨™ç›®å‰æ²’æœ‰è³‡æ–™",
                left: "center",
                top: "middle",
                textStyle: { color: "#9ca3af", fontSize: 14 },
                },
            });
            return;
            }

            const x = series.map((p) => p.period);
            const y = series.map((p) => p.value);
            const percent = isPercentMetric(key);

            const option = {
            backgroundColor: "transparent",
            grid: {
                left: 72,
                right: 20,
                top: 30,
                bottom: 40,
            },
            tooltip: {
                trigger: "axis",
                axisPointer: { type: "line" },
                valueFormatter: (v) => {
                if (v == null) return "-";
                return percent
                    ? Number(v).toFixed(2) + "%"
                    : formatNumberAbbrev(v);
                },
            },
            xAxis: {
                type: "category",
                data: x,
                axisLine: { lineStyle: { color: "#4b5563" } },
                axisLabel: { color: "#9ca3af" },
            },
            yAxis: {
                type: "value",
                scale: true,
                min: (v) =>
                percent
                    ? Math.floor(v.min - 1)
                    : v.min > 0
                    ? v.min * 0.9
                    : v.min * 1.1,
                max: (v) =>
                percent
                    ? Math.ceil(v.max + 1)
                    : v.max > 0
                    ? v.max * 1.1
                    : v.max * 0.9,
                axisLine: { lineStyle: { color: "#4b5563" } },
                axisLabel: {
                color: "#e5e7eb",
                formatter: (value) =>
                    percent
                    ? Number(value).toFixed(0) + "%"
                    : formatNumberAbbrev(value),
                },
                splitLine: { lineStyle: { color: "#1f2937" } },
            },
            series: [
                {
                name: metricNameMap[key] || key,
                type: "line",
                smooth: true,
                showSymbol: true,
                symbol: "circle",
                symbolSize: 6,
                lineStyle: { width: 2 },
                areaStyle: { opacity: 0.08 },
                data: y,
                },
            ],
            };

            fundChart.setOption(option, true);
        }

        // é è¨­å…ˆç•«ã€Œç‡Ÿæ”¶ã€
        renderMetric("revenue");

        // æŒ‡æ¨™åˆ‡æ›æŒ‰éˆ•ï¼ˆä¸€å®šè¦åœ¨ init ä¹‹å¾Œç¶ï¼‰
        document.querySelectorAll(".metric-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
            document
                .querySelectorAll(".metric-btn")
                .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            renderMetric(btn.dataset.metric);
            });
        });

        // è¦–çª—å¤§å°è®ŠåŒ–æ™‚ï¼Œè®“åœ–è¡¨è·Ÿè‘— resize
        window.addEventListener("resize", () => {
            if (fundChart) fundChart.resize();
        });
        }

        // ===== 3. Tab åˆ‡æ› =====
        document.querySelectorAll(".fund-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
            const target = tab.dataset.tab;

            document
            .querySelectorAll(".fund-tab")
            .forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");

            document
            .querySelectorAll(".fund-panel")
            .forEach((p) => p.classList.remove("active"));
            document.getElementById("tab-" + target).classList.add("active");

            // ğŸ‘‰ ç•¶åˆ‡åˆ°ã€Œè²¡å ±è¶¨å‹¢åœ–ã€æ™‚ï¼Œæ‰åˆå§‹åŒ–ä¸¦å¼·åˆ¶ resize ä¸€æ¬¡
            if (target === "trend") {
            initFundChart();
            setTimeout(() => {
                if (fundChart) fundChart.resize();
            }, 0);
            }
        });
        });

        // å¦‚æœå“ªå¤©ä½ æ”¹æˆé è¨­ä¸€é€²ä¾†å°±é–‹ã€Œè²¡å ±è¶¨å‹¢åœ–ã€ï¼Œé€™è£¡ä¹Ÿæœƒè‡ªå‹•å¹«ä½  init ä¸€æ¬¡
        const activeTab = document.querySelector(".fund-tab.active");
        if (activeTab && activeTab.dataset.tab === "trend") {
        initFundChart();
        setTimeout(() => {
            if (fundChart) fundChart.resize();
        }, 0);
        }

    </script>
  {% endif %}
</body>
</html>
