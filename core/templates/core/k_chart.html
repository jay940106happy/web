<!DOCTYPE html>
<html lang="zh-Hant">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <!-- ✅ 開放手機整頁縮放 -->
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes"
  />

  <title>K 線圖</title>
  <link rel="stylesheet" href="{% static 'core/style.css' %}" />

  <!-- ✅ 改用 TradingView Lightweight Charts（支援手機雙指縮放） -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

</head>
<body>
  <h1>測試 K 線圖</h1>

  <form method="get" action="{% url 'k_chart' %}">
    <label>
      股票代號：
      <input
        type="text"
        name="code"
        value="{{ raw_code|default:'2330' }}"
        placeholder="2330"
      />
    </label>
    <button type="submit">查詢</button>
  </form>


  {# ===== 上方專業頭部資訊（像 Yahoo 那一塊） ===== #}
  {% if company_name and last_close %}
    {% with is_up=last_change|default:0|floatformat:4 %}
    <div class="quote-header">
      <div class="quote-main">
        <span class="symbol">{{ raw_code|upper }}</span>
        <span class="name">{{ company_name }}</span>
      </div>
      <div class="quote-price">
        <span class="price">{{ last_close|floatformat:2 }}</span>
        {% if last_change %}
          {% if last_change > 0 %}
            <span class="change up">
              ▲ {{ last_change|floatformat:2 }}
              ({{ last_change_pct|floatformat:2 }}%)
            </span>
          {% elif last_change < 0 %}
            <span class="change down">
              ▼ {{ last_change|floatformat:2 }}
              ({{ last_change_pct|floatformat:2 }}%)
            </span>
          {% else %}
            <span class="change flat">
              0.00 (0.00%)
            </span>
          {% endif %}
        {% endif %}
      </div>
      {% if last_date %}
        <div class="quote-date">
          收盤價 · {{ last_date }}
        </div>
      {% endif %}
    </div>
    {% endwith %}
  {% endif %}

  {% if error %}
    <p style="color: red">{{ error }}</p>
  {% endif %}

  {% if not error %}
    <h2>{{ symbol }} 日 K</h2>
    <div id="kchart" style="width: 100%; height: 600px;"></div>

<script>
  // 後端丟過來的資料：[{ date, open, high, low, close, volume }, ...]
  const ohlc = {{ ohlc_json|default:"[]"|safe }};

  if (ohlc.length > 0) {
    const container = document.getElementById("kchart");
    const chart = echarts.init(container, null, { renderer: "canvas" });

    // ---- 整理資料給 ECharts 用 ----
    const dates = ohlc.map(r => r.date);   // x 軸
    const kData = ohlc.map(r => [
      r.open,   // ECharts: [open, close, low, high]
      r.close,
      r.low,
      r.high,
    ]);

    const volumeData = ohlc.map((r, idx) => {
      const up = r.close >= r.open;
      return {
        value: [idx, r.volume, up ? 1 : -1], // 1 = 上漲, -1 = 下跌
      };
    });

    const option = {
      backgroundColor: "#0f172a",
      animation: false,
      tooltip: {
        trigger: "axis",
        axisPointer: {
          type: "cross",
          label: { backgroundColor: "#374151" }
        }
      },
      axisPointer: {
        link: [{ xAxisIndex: [0, 1] }]
      },
      grid: [
        {
          left: 50,
          right: 20,
          top: 40,
          height: "58%"      // 上面 K 線
        },
        {
          left: 50,
          right: 20,
          top: "70%",
          height: "18%"      // 下面成交量
        }
      ],
      xAxis: [
        {
          type: "category",
          data: dates,
          boundaryGap: false,
          axisLine: { lineStyle: { color: "#4b5563" } },
          axisLabel: { color: "#9ca3af" },
          min: "dataMin",
          max: "dataMax"
        },
        {
          type: "category",
          gridIndex: 1,
          data: dates,
          boundaryGap: false,
          axisLine: { lineStyle: { color: "#4b5563" } },
          axisLabel: { color: "#9ca3af" },
          min: "dataMin",
          max: "dataMax"
        }
      ],
      yAxis: [
        {
          scale: true,
          position: "right",
          axisLine: { lineStyle: { color: "#4b5563" } },
          axisLabel: { color: "#e5e7eb" },
          splitLine: { lineStyle: { color: "#1f2937" } }
        },
        {
          gridIndex: 1,
          position: "right",
          axisLine: { lineStyle: { color: "#4b5563" } },
          axisLabel: {
            color: "#9ca3af",
            formatter: value => {
              if (value >= 1e8) return (value / 1e8).toFixed(1) + "億";
              if (value >= 1e4) return (value / 1e4).toFixed(1) + "萬";
              return value;
            }
          },
          splitLine: { show: false }
        }
      ],

      // ✅ 手機雙指縮放 / 一指平移：靠 dataZoom
      dataZoom: [
        {
          type: "inside",   // 內建：二指縮放 + 拖曳平移（手機 / 滑鼠都支援）
          xAxisIndex: [0, 1],
          minSpan: 5        // 最少顯示幾根 K 線，避免縮太誇張
        },
        {
          type: "slider",   // 底下滑桿（桌機好用）
          xAxisIndex: [0, 1],
          height: 16,
          bottom: 10
        }
      ],

      series: [
        {
          name: "K 線",
          type: "candlestick",
          data: kData,
          itemStyle: {
            color: "#ff5c5c",          // 漲紅
            color0: "#26e27a",         // 跌綠
            borderColor: "#ff5c5c",
            borderColor0: "#26e27a"
          }
        },
        {
          name: "成交量",
          type: "bar",
          xAxisIndex: 1,
          yAxisIndex: 1,
          data: volumeData,
          itemStyle: {
            color: params => {
              // volumeData 的第三個值 1 / -1 決定顏色
              return params.data.value[2] === 1 ? "#ff5c5c" : "#26e27a";
            }
          }
        }
      ]
    };

    chart.setOption(option);

    // 視窗大小變化時自動調整
    window.addEventListener("resize", () => {
      chart.resize();
    });
  }
</script>




  {% endif %}







</body>
</html>
