<!DOCTYPE html>
<html lang="zh-Hant">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <title>K 線圖</title>
  <link rel="stylesheet" href="{% static 'core/style.css' %}" />
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
</head>
<body>
  <h1>測試 K 線圖</h1>

  <form method="get" action="{% url 'k_chart' %}">
    <label>
      股票代號：
      <input
        type="text"
        name="code"
        value="{{ raw_code|default:'2330' }}"
        placeholder="2330"
      />
    </label>
    <button type="submit">查詢</button>
  </form>


  {# ===== 上方專業頭部資訊（像 Yahoo 那一塊） ===== #}
  {% if company_name and last_close %}
    {% with is_up=last_change|default:0|floatformat:4 %}
    <div class="quote-header">
      <div class="quote-main">
        <span class="symbol">{{ raw_code|upper }}</span>
        <span class="name">{{ company_name }}</span>
      </div>
      <div class="quote-price">
        <span class="price">{{ last_close|floatformat:2 }}</span>
        {% if last_change %}
          {% if last_change > 0 %}
            <span class="change up">
              ▲ {{ last_change|floatformat:2 }}
              ({{ last_change_pct|floatformat:2 }}%)
            </span>
          {% elif last_change < 0 %}
            <span class="change down">
              ▼ {{ last_change|floatformat:2 }}
              ({{ last_change_pct|floatformat:2 }}%)
            </span>
          {% else %}
            <span class="change flat">
              0.00 (0.00%)
            </span>
          {% endif %}
        {% endif %}
      </div>
      {% if last_date %}
        <div class="quote-date">
          收盤價 · {{ last_date }}
        </div>
      {% endif %}
    </div>
    {% endwith %}
  {% endif %}

  {% if error %}
    <p style="color: red">{{ error }}</p>
  {% endif %}

  {% if not error %}
    <h2>{{ symbol }} 日 K</h2>
    <div id="kchart" style="width: 100%; height: 600px;"></div>

<script>
  const ohlc = {{ ohlc_json|default:"[]"|safe }};

  if (ohlc.length > 0) {
    const dates  = ohlc.map(r => r.date);   // "YYYY-MM-DD"
    const open   = ohlc.map(r => r.open);
    const high   = ohlc.map(r => r.high);
    const low    = ohlc.map(r => r.low);
    const close  = ohlc.map(r => r.close);
    const volume = ohlc.map(r => r.volume);

    const minDate = dates[0];
    const maxDate = dates[dates.length - 1];

    // ===== 找出「缺少的日期」全部列出來（週末＋國定假日都會被抓到） =====
    const dateSet = new Set(dates);
    const missingDates = [];

    let cur = new Date(minDate);
    const end = new Date(maxDate);

    while (cur <= end) {
      const ds = cur.toISOString().slice(0, 10); // YYYY-MM-DD
      if (!dateSet.has(ds)) {
        missingDates.push(ds);
      }
      cur.setDate(cur.getDate() + 1);
    }

    // ===== K 線：漲紅跌綠、蠟燭變胖、影線無橫線 =====
    const candle = {
      x: dates,
      open,
      high,
      low,
      close,
      type: "candlestick",
      name: "K 線",
      xaxis: "x",
      yaxis: "y",
      increasing: {
        line: { color: "#ff5c5c", width: 1 },
        fillcolor: "#ff5c5c",
      },
      decreasing: {
        line: { color: "#26e27a", width: 1 },
        fillcolor: "#26e27a",
      },
      width: 0.9,
      whiskerwidth: 0,
    };

    // ===== 成交量（同樣紅漲綠跌） =====
    const volUp   = [];
    const volDown = [];

    for (let i = 0; i < dates.length; i++) {
      if (close[i] >= open[i]) {
        volUp.push(volume[i]);
        volDown.push(0);
      } else {
        volUp.push(0);
        volDown.push(volume[i]);
      }
    }

    const volUpTrace = {
      x: dates,
      y: volUp,
      type: "bar",
      name: "成交量 ↑",
      xaxis: "x",
      yaxis: "y2",
      marker: { color: "#ff5c5c" },
      opacity: 0.5,
    };

    const volDownTrace = {
      x: dates,
      y: volDown,
      type: "bar",
      name: "成交量 ↓",
      xaxis: "x",
      yaxis: "y2",
      marker: { color: "#26e27a" },
      opacity: 0.5,
    };

    // 預設看最近約 200 根（日 K）
    const lastIdx   = dates.length - 1;
    const startIdx  = Math.max(0, dates.length - 200);
    const initialRange = [dates[startIdx], dates[lastIdx]];

    const layout = {
      dragmode: "pan",
      showlegend: false,
      xaxis: {
        type: "date",
        range: initialRange,
        rangebreaks: missingDates.length ? [{ values: missingDates }] : [],
        rangeslider: { visible: false },
        rangeselector: {
          buttons: [
            { count: 3,  label: "3M", step: "month", stepmode: "backward" },
            { count: 6,  label: "6M", step: "month", stepmode: "backward" },
            { count: 1,  label: "1Y", step: "year",  stepmode: "backward" },
            { count: 3,  label: "3Y", step: "year",  stepmode: "backward" },
            { step: "all", label: "全部" },
          ],
        },
      },
      yaxis: {
        domain: [0.3, 1],
        title: "價格",
        fixedrange: true,
      },
      yaxis2: {
        domain: [0, 0.25],
        title: "成交量",
        fixedrange: true,
      },
      margin: { t: 30, r: 20, b: 40, l: 50 },
    };

    const config = {
      responsive: true,
      scrollZoom: true,
      displaylogo: false,
      modeBarButtonsToRemove: [
        "zoom2d",
        "zoomIn2d",
        "zoomOut2d",
        "autoScale2d",
        "resetScale2d",
        "lasso2d",
        "select2d",
        "toggleSpikelines",
        "hoverClosestCartesian",
        "hoverCompareCartesian",
        "toImage",
      ],
      doubleClick: "reset",
    };

    // ===== clamp + y-range 自動貼近高低點 =====
    function clampRange(range) {
      let [start, end] = range;
      if (start < minDate) start = minDate;
      if (end   > maxDate) end   = maxDate;
      if (start > end) [start, end] = [end, start];
      return [start, end];
    }

    // 價格 y 軸
    function calcYRange(xRange) {
      const [start, end] = xRange;
      let min = Infinity;
      let max = -Infinity;

      for (let i = 0; i < dates.length; i++) {
        const d = dates[i];
        if (d >= start && d <= end) {
          const lo = low[i];
          const hi = high[i];
          if (lo < min) min = lo;
          if (hi > max) max = hi;
        }
      }

      if (min === Infinity || max === -Infinity) return null;

      const padding = (max - min) * 0.1 || 1;
      return [min - padding, max + padding];
    }

    // ✅ 新增：成交量 y2 軸（只看目前畫面範圍內的最大量）
    function calcVolRange(xRange) {
      const [start, end] = xRange;
      let maxVol = 0;

      for (let i = 0; i < dates.length; i++) {
        const d = dates[i];
        if (d >= start && d <= end) {
          if (volume[i] > maxVol) maxVol = volume[i];
        }
      }

      if (maxVol <= 0) return null;

      return [0, maxVol * 1.2]; // 往上留 20% 空間
    }

    let internalUpdate = false;

    Plotly.newPlot("kchart", [candle, volUpTrace, volDownTrace], layout, config)
      .then(() => {
        const initClamped = clampRange(initialRange);
        const initY  = calcYRange(initClamped);
        const initV2 = calcVolRange(initClamped);

        if (initY && initV2) {
          internalUpdate = true;
          Plotly.relayout("kchart", {
            "xaxis.range": initClamped,
            "yaxis.range": initY,
            "yaxis2.range": initV2,
          }).then(() => { internalUpdate = false; });
        }

        const kDiv = document.getElementById("kchart");

        kDiv.on("plotly_relayout", (ev) => {
          if (internalUpdate) {
            internalUpdate = false;
            return;
          }

          let newRange = null;

          if (ev["xaxis.range[0]"] && ev["xaxis.range[1]"]) {
            newRange = [ev["xaxis.range[0]"], ev["xaxis.range[1]"]];
          } else if (ev["xaxis.autorange"]) {
            newRange = [minDate, maxDate];
          } else {
            return;
          }

          const clamped = clampRange(newRange);
          const yRange  = calcYRange(clamped);
          const v2Range = calcVolRange(clamped);
          if (!yRange || !v2Range) return;

          internalUpdate = true;
          Plotly.relayout("kchart", {
            "xaxis.range":  clamped,
            "yaxis.range":  yRange,
            "yaxis2.range": v2Range,
          }).then(() => { internalUpdate = false; });
        });
      });
  }
</script>





  {% endif %}
</body>
</html>
